{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<style>
.select2-container--bootstrap-5 .select2-selection {
    min-height: calc(1.5em + 0.75rem + 2px);
}
.formset-row input, .formset-row select {
    font-size: 0.875rem;
}
</style>
{% endblock %}

{% block title %}
{% if object %}Editar Orden de Compra{% else %}Nueva Orden de Compra{% endif %} - Compras
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">
                {% if object %}
                    <i class="fas fa-edit text-warning me-2"></i>
                    Editar Orden de Compra: {{ object.numero }}
                {% else %}
                    <i class="fas fa-plus-circle text-success me-2"></i>
                    Nueva Orden de Compra
                {% endif %}
            </h1>
            <p class="text-muted mb-0">
                {% if object %}
                    Actualizar información de la orden de compra
                {% else %}
                    Crear nueva orden de compra para proveedor
                {% endif %}
            </p>
        </div>
        <div>
            <a href="{% url 'compras:orden_list' %}" class="btn btn-outline-secondary me-2">
                <i class="fas fa-arrow-left me-1"></i> Volver
            </a>
            {% if object %}
            <a href="{% url 'compras:orden_detail' object.pk %}" class="btn btn-outline-info">
                <i class="fas fa-eye me-1"></i> Ver Detalle
            </a>
            {% endif %}
        </div>
    </div>

    {% if form.errors %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <h6><i class="fas fa-exclamation-triangle me-2"></i>Errores en el formulario:</h6>
        <ul class="mb-0">
            {% for field, errors in form.errors.items %}
                {% for error in errors %}
                    <li>
                        {% if field != '__all__' %}<strong>{{ form.fields.field.label|default:field }}:</strong>{% endif %}
                        {{ error }}
                    </li>
                {% endfor %}
            {% endfor %}
        </ul>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    <form method="post" novalidate>
        {% csrf_token %}
        
        <div class="row">
            <!-- Formulario Principal -->
            <div class="col-lg-8">
                <!-- Información Básica -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-file-invoice me-2 text-primary"></i>
                            Información de la Orden
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <!-- Proveedor -->
                            <div class="col-12">
                                <label for="{{ form.proveedor.id_for_label }}" class="form-label">
                                    Proveedor *
                                </label>
                                {{ form.proveedor }}
                                {% if form.proveedor.help_text %}
                                    <div class="form-text">{{ form.proveedor.help_text }}</div>
                                {% endif %}
                                {% if form.proveedor.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.proveedor.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Fecha de Entrega Estimada -->
                            <div class="col-md-6">
                                <label for="{{ form.fecha_entrega_estimada.id_for_label }}" class="form-label">
                                    Fecha de Entrega Estimada
                                </label>
                                {{ form.fecha_entrega_estimada }}
                                {% if form.fecha_entrega_estimada.help_text %}
                                    <div class="form-text">{{ form.fecha_entrega_estimada.help_text }}</div>
                                {% endif %}
                                {% if form.fecha_entrega_estimada.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.fecha_entrega_estimada.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Número de Referencia del Proveedor -->
                            <div class="col-md-6">
                                <label for="{{ form.numero_referencia_proveedor.id_for_label }}" class="form-label">
                                    Referencia del Proveedor
                                </label>
                                {{ form.numero_referencia_proveedor }}
                                {% if form.numero_referencia_proveedor.help_text %}
                                    <div class="form-text">{{ form.numero_referencia_proveedor.help_text }}</div>
                                {% endif %}
                                {% if form.numero_referencia_proveedor.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.numero_referencia_proveedor.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Observaciones y Condiciones -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-clipboard-list me-2 text-info"></i>
                            Observaciones y Condiciones
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <!-- Observaciones -->
                            <div class="col-12">
                                <label for="{{ form.observaciones.id_for_label }}" class="form-label">
                                    Observaciones
                                </label>
                                {{ form.observaciones }}
                                {% if form.observaciones.help_text %}
                                    <div class="form-text">{{ form.observaciones.help_text }}</div>
                                {% endif %}
                                {% if form.observaciones.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.observaciones.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Condiciones Especiales -->
                            <div class="col-12">
                                <label for="{{ form.condiciones_especiales.id_for_label }}" class="form-label">
                                    Condiciones Especiales
                                </label>
                                {{ form.condiciones_especiales }}
                                {% if form.condiciones_especiales.help_text %}
                                    <div class="form-text">{{ form.condiciones_especiales.help_text }}</div>
                                {% endif %}
                                {% if form.condiciones_especiales.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.condiciones_especiales.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Items de la Orden -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-boxes me-2 text-primary"></i>
                            Items de la Orden
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if formset.errors %}
                        <div class="alert alert-danger">
                            <h6>Errores en los items:</h6>
                            <ul class="mb-0">
                                {% for error in formset.non_form_errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}

                        <div id="formset-container">
                            {{ formset.management_form }}
                            
                            <div class="table-responsive">
                                <table class="table table-bordered" id="items-table">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 35%;">Producto *</th>
                                            <th style="width: 20%;">Variante</th>
                                            <th style="width: 12%;">Cantidad *</th>
                                            <th style="width: 15%;">Precio Unit. *</th>
                                            <th style="width: 10%;">Descuento %</th>
                                            <th style="width: 5%;">Eliminar</th>
                                        </tr>
                                    </thead>
                                    <tbody id="formset-body">
                                        {% for form in formset %}
                                        <tr class="formset-row" data-form-prefix="{{ form.prefix }}">
                                            <td>
                                                {{ form.producto }}
                                                {% if form.producto.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {% for error in form.producto.errors %}{{ error }}{% endfor %}
                                                    </div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {{ form.variante }}
                                                {% if form.variante.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {% for error in form.variante.errors %}{{ error }}{% endfor %}
                                                    </div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {{ form.cantidad }}
                                                {% if form.cantidad.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {% for error in form.cantidad.errors %}{{ error }}{% endfor %}
                                                    </div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {{ form.precio_unitario }}
                                                {% if form.precio_unitario.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {% for error in form.precio_unitario.errors %}{{ error }}{% endfor %}
                                                    </div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {{ form.descuento_porcentaje }}
                                                {% if form.descuento_porcentaje.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {% for error in form.descuento_porcentaje.errors %}{{ error }}{% endfor %}
                                                    </div>
                                                {% endif %}
                                            </td>
                                            <td class="text-center">
                                                {% if form.instance.pk %}
                                                    {{ form.DELETE }}
                                                    <label for="{{ form.DELETE.id_for_label }}" class="btn btn-outline-danger btn-sm">
                                                        <i class="fas fa-trash"></i>
                                                    </label>
                                                {% else %}
                                                    <button type="button" class="btn btn-outline-danger btn-sm remove-row">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                {% endif %}
                                                {{ form.id }}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="text-center mt-3">
                            <button type="button" class="btn btn-outline-primary" id="add-item">
                                <i class="fas fa-plus me-1"></i> Agregar Item
                            </button>
                        </div>

                        <!-- Template para nuevas filas (oculto) -->
                        <table style="display: none;">
                            <tbody id="empty-form-template">
                                <tr class="formset-row" data-form-prefix="__prefix__">
                                    <td>
                                        {{ formset.empty_form.producto }}
                                    </td>
                                    <td>
                                        {{ formset.empty_form.variante }}
                                    </td>
                                    <td>
                                        {{ formset.empty_form.cantidad }}
                                    </td>
                                    <td>
                                        {{ formset.empty_form.precio_unitario }}
                                    </td>
                                    <td>
                                        {{ formset.empty_form.descuento_porcentaje }}
                                    </td>
                                    <td class="text-center">
                                        <button type="button" class="btn btn-outline-danger btn-sm remove-row">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                        {{ formset.empty_form.id }}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Botones de Acción -->
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'compras:orden_list' %}" class="btn btn-secondary">
                                <i class="fas fa-times me-1"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save me-1"></i>
                                {% if object %}
                                    Actualizar Orden
                                {% else %}
                                    Crear Orden
                                {% endif %}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Panel Lateral de Ayuda -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-info-circle me-2 text-info"></i>
                            Información
                        </h6>
                    </div>
                    <div class="card-body">
                        {% if not object %}
                        <div class="alert alert-info mb-3">
                            <h6 class="alert-heading">
                                <i class="fas fa-lightbulb me-1"></i> Nueva Orden
                            </h6>
                            <p class="mb-0">
                                El número de orden se generará automáticamente al guardar.
                            </p>
                        </div>
                        {% else %}
                        <div class="alert alert-warning mb-3">
                            <h6 class="alert-heading">
                                <i class="fas fa-edit me-1"></i> Editando Orden
                            </h6>
                            <p class="mb-0">
                                <strong>Número:</strong> {{ object.numero }}<br>
                                <strong>Estado:</strong> {{ object.get_estado_display }}<br>
                                <strong>Creada:</strong> {{ object.fecha_orden|date:"d/m/Y" }}
                            </p>
                        </div>
                        {% endif %}
                        
                        <h6 class="mb-2">Campos Obligatorios:</h6>
                        <ul class="list-unstyled mb-3">
                            <li><i class="fas fa-check-circle text-success me-2"></i> Proveedor</li>
                        </ul>
                        
                        <h6 class="mb-2">Campos Opcionales:</h6>
                        <ul class="list-unstyled mb-3">
                            <li><i class="fas fa-circle text-muted me-2"></i> Fecha de entrega estimada</li>
                            <li><i class="fas fa-circle text-muted me-2"></i> Referencia del proveedor</li>
                            <li><i class="fas fa-circle text-muted me-2"></i> Observaciones</li>
                            <li><i class="fas fa-circle text-muted me-2"></i> Condiciones especiales</li>
                        </ul>
                        
                        {% if not object %}
                        <div class="alert alert-light">
                            <h6 class="mb-2">Próximos Pasos:</h6>
                            <ol class="mb-0">
                                <li>Crear la orden de compra</li>
                                <li>Añadir productos a la orden</li>
                                <li>Enviar al proveedor</li>
                                <li>Gestionar recepción</li>
                            </ol>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Panel de Estado (solo en edición) -->
                {% if object %}
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-chart-line me-2 text-success"></i>
                            Estado de la Orden
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <strong>Estado Actual:</strong><br>
                            <span class="badge bg-{% if object.estado == 'borrador' %}secondary{% elif object.estado == 'enviada' %}warning{% elif object.estado == 'confirmada' %}info{% elif object.estado == 'recibida_total' %}success{% elif object.estado == 'cancelada' %}danger{% else %}primary{% endif %}">
                                {{ object.get_estado_display }}
                            </span>
                        </div>
                        
                        <div class="mb-3">
                            <strong>Totales:</strong><br>
                            Subtotal: ${{ object.subtotal|floatformat:0 }}<br>
                            IVA: ${{ object.iva|floatformat:0 }}<br>
                            <strong>Total: ${{ object.total|floatformat:0 }}</strong>
                        </div>
                        
                        <div class="mb-0">
                            <strong>Fechas:</strong><br>
                            Creación: {{ object.fecha_orden|date:"d/m/Y" }}<br>
                            {% if object.fecha_entrega_estimada %}
                            Entrega estimada: {{ object.fecha_entrega_estimada|date:"d/m/Y" }}<br>
                            {% endif %}
                            {% if object.fecha_entrega_real %}
                            Entrega real: {{ object.fecha_entrega_real|date:"d/m/Y" }}
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </form>
</div>

<!-- jQuery y Select2 JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Inicializando formulario de orden de compra...');
    
    // Variables principales
    const addButton = document.getElementById('add-item');
    const formsetBody = document.getElementById('formset-body');
    const totalForms = document.querySelector('#id_items-TOTAL_FORMS');
    const form = document.querySelector('form');
    let formChanged = false;
    
    // Verificar que los elementos existen
    if (!addButton || !formsetBody || !totalForms) {
        console.error('❌ Elementos del formset no encontrados');
        return;
    }
    
    console.log('✅ Elementos del formset encontrados');
    
    // Inicializar Select2 para productos
    function initializeSelect2() {
        $('.select2-producto').select2({
            theme: 'bootstrap-5',
            placeholder: 'Buscar producto...',
            allowClear: true,
            width: '100%',
            language: {
                noResults: function() {
                    return "No se encontraron productos";
                },
                inputTooShort: function() {
                    return "Escribe al menos 2 caracteres";
                }
            },
            minimumInputLength: 2
        });
        
        $('.select2-variante').select2({
            theme: 'bootstrap-5',
            placeholder: 'Seleccionar variante...',
            allowClear: true,
            width: '100%'
        });
    }
    
    // Aplicar estilos Bootstrap y Select2
    function applyStyles() {
        // Aplicar clases Bootstrap
        document.querySelectorAll('#formset-container input[type="number"], #formset-container input[type="text"]').forEach(field => {
            field.classList.add('form-control', 'form-control-sm');
        });
        
        document.querySelectorAll('#formset-container select').forEach(field => {
            if (!field.classList.contains('select2-hidden-accessible')) {
                field.classList.add('form-select', 'form-select-sm');
                
                // Agregar clases para Select2
                if (field.name && field.name.includes('producto')) {
                    field.classList.add('select2-producto');
                } else if (field.name && field.name.includes('variante')) {
                    field.classList.add('select2-variante');
                }
            }
        });
        
        // Inicializar Select2
        initializeSelect2();
    }
    
    // Función para actualizar índices del formset
    function updateFormIndexes() {
        const rows = formsetBody.querySelectorAll('.formset-row');
        rows.forEach((row, index) => {
            const inputs = row.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                const name = input.getAttribute('name');
                if (name && name.includes('items-')) {
                    const newName = name.replace(/items-\d+/, `items-${index}`);
                    input.setAttribute('name', newName);
                    input.setAttribute('id', `id_${newName}`);
                }
            });
            
            row.setAttribute('data-form-prefix', `items-${index}`);
        });
        
        totalForms.value = rows.length;
        console.log(`📊 Formularios actualizados: ${rows.length}`);
    }
    
    // Agregar nuevo item
    addButton.addEventListener('click', function() {
        console.log('➕ Agregando nuevo item...');
        
        const template = document.getElementById('empty-form-template');
        if (!template) {
            console.error('❌ Template no encontrado');
            return;
        }
        
        const formIndex = parseInt(totalForms.value);
        console.log(`📝 Índice del nuevo formulario: ${formIndex}`);
        
        // Crear nueva fila
        const newRow = document.createElement('tr');
        newRow.className = 'formset-row';
        newRow.setAttribute('data-form-prefix', `items-${formIndex}`);
        
        // Obtener el HTML del template y reemplazar __prefix__
        let templateHTML = template.innerHTML;
        templateHTML = templateHTML.replace(/__prefix__/g, formIndex);
        newRow.innerHTML = templateHTML;
        
        // Agregar al DOM
        formsetBody.appendChild(newRow);
        
        // Actualizar contador
        totalForms.value = formIndex + 1;
        
        // Aplicar estilos y funcionalidad
        applyStyles();
        
        // Agregar event listener para eliminar
        const removeBtn = newRow.querySelector('.remove-row');
        if (removeBtn) {
            removeBtn.addEventListener('click', function() {
                console.log('🗑️ Eliminando item...');
                newRow.remove();
                updateFormIndexes();
                applyStyles();
            });
        }
        
        // Focus en el primer campo
        setTimeout(() => {
            const productSelect = newRow.querySelector('select[name*="producto"]');
            if (productSelect) {
                $(productSelect).select2('open');
            }
        }, 100);
        
        console.log('✅ Item agregado exitosamente');
    });
    
    // Event listeners para botones de eliminar existentes
    document.querySelectorAll('.remove-row').forEach(btn => {
        btn.addEventListener('click', function() {
            console.log('🗑️ Eliminando item existente...');
            btn.closest('tr').remove();
            updateFormIndexes();
            applyStyles();
        });
    });
    
    // Detección de cambios
    form.addEventListener('input', () => formChanged = true);
    form.addEventListener('change', () => formChanged = true);
    
    // Confirmación antes de cancelar
    const cancelBtn = form.querySelector('a[href*="orden_list"]');
    if (cancelBtn) {
        cancelBtn.addEventListener('click', function(e) {
            if (formChanged && !confirm('¿Estás seguro de que quieres cancelar? Los cambios se perderán.')) {
                e.preventDefault();
            }
        });
    }
    
    // Aplicar estilos iniciales
    applyStyles();
    
    // Auto-focus en el primer campo
    setTimeout(() => {
        const firstField = document.querySelector('select[name="proveedor"]');
        if (firstField) {
            firstField.focus();
        }
    }, 500);
    
    console.log('🎯 Formulario inicializado completamente');
});
</script>
{% endblock %}