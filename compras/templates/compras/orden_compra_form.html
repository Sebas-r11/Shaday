{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<style>
.select2-container--bootstrap-5 .select2-selection {
    min-height: calc(1.5em + 0.75rem + 2px);
}
.formset-row input, .formset-row select {
    font-size: 0.875rem;
}
</style>
{% endblock %}

{% block title %}
{% if object %}Editar Orden de Compra{% else %}Nueva Orden de Compra{% endif %} - Compras
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-6">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- Header unificado -->
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">
                    {% if object %}
                        <i class="fas fa-edit mr-2 text-yellow-600"></i>
                        Editar Orden de Compra: {{ object.numero }}
                    {% else %}
                        <i class="fas fa-plus-circle mr-2 text-green-600"></i>
                        Nueva Orden de Compra
                    {% endif %}
                </h1>
                <p class="text-gray-600 mt-2">
                    {% if object %}
                        Actualizar información de la orden de compra
                    {% else %}
                        Crear nueva orden de compra para proveedor
                    {% endif %}
                </p>
            </div>
            <div class="flex space-x-2">
                <a href="{% url 'compras:orden_list' %}" class="border border-gray-300 text-gray-700 bg-white hover:bg-gray-50 px-4 py-2 rounded-md text-sm font-medium transition-colors">
                    <i class="fas fa-arrow-left mr-1"></i> Volver
                </a>
                {% if object %}
                    <a href="{% url 'compras:orden_detail' object.pk %}" class="border border-blue-600 text-blue-600 hover:bg-blue-50 px-4 py-2 rounded-md text-sm font-medium transition-colors">
                        <i class="fas fa-eye mr-1"></i> Ver Detalle
                    </a>
                {% endif %}
            </div>
        </div>

        {% if form.errors %}
        <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fas fa-exclamation-triangle text-red-600"></i>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-red-800">Errores en el formulario:</h3>
                    <div class="mt-2 text-sm text-red-700">
                        <ul class="list-disc list-inside space-y-1">
                            {% for field, errors in form.errors.items %}
                                {% for error in errors %}
                                    <li>
                                        {% if field != '__all__' %}<strong>{{ form.fields.field.label|default:field }}:</strong>{% endif %}
                                        {{ error }}
                                    </li>
                                {% endfor %}
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <form method="post" novalidate>
            {% csrf_token %}
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Formulario Principal -->
                <div class="lg:col-span-2">
                    <!-- Información Básica -->
                    <div class="bg-white shadow rounded-lg mb-6">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-medium text-gray-900">
                                <i class="fas fa-file-invoice mr-2 text-blue-600"></i>
                                Información de la Orden
                            </h3>
                        </div>
                        <div class="p-6">
                            <div class="grid md:grid-cols-2 gap-4">
                                <!-- Proveedor -->
                                <div class="md:col-span-2">
                                    <label for="{{ form.proveedor.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                        Proveedor *
                                    </label>
                                    {{ form.proveedor }}
                                    {% if form.proveedor.help_text %}
                                        <div class="text-gray-600 text-sm mt-1">{{ form.proveedor.help_text }}</div>
                                    {% endif %}
                                    {% if form.proveedor.errors %}
                                        <div class="text-red-600 text-sm mt-1">
                                            {% for error in form.proveedor.errors %}
                                                <div>{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Fecha de Entrega Estimada -->
                                <div>
                                    <label for="{{ form.fecha_entrega_estimada.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                        Fecha de Entrega Estimada
                                    </label>
                                    {{ form.fecha_entrega_estimada }}
                                    {% if form.fecha_entrega_estimada.help_text %}
                                        <div class="text-gray-600 text-sm mt-1">{{ form.fecha_entrega_estimada.help_text }}</div>
                                    {% endif %}
                                    {% if form.fecha_entrega_estimada.errors %}
                                        <div class="text-red-600 text-sm mt-1">
                                            {% for error in form.fecha_entrega_estimada.errors %}
                                                <div>{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Número de Referencia del Proveedor -->
                                <div>
                                    <label for="{{ form.numero_referencia_proveedor.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                        Referencia del Proveedor
                                    </label>
                                    {{ form.numero_referencia_proveedor }}
                                    {% if form.numero_referencia_proveedor.help_text %}
                                        <div class="text-gray-600 text-sm mt-1">{{ form.numero_referencia_proveedor.help_text }}</div>
                                    {% endif %}
                                    {% if form.numero_referencia_proveedor.errors %}
                                        <div class="text-red-600 text-sm mt-1">
                                            {% for error in form.numero_referencia_proveedor.errors %}
                                                <div>{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Observaciones y Condiciones -->
                <div class="bg-white shadow-sm rounded-lg border border-gray-200 mb-6">
                    <div class="border-b border-gray-200 px-6 py-4">
                        <h5 class="text-lg font-semibold text-gray-900 mb-0">
                            <i class="fas fa-clipboard-list mr-2 text-blue-600"></i>
                            Observaciones y Condiciones
                        </h5>
                    </div>
                    <div class="p-6">
                        <div class="space-y-4">
                            <!-- Observaciones -->
                            <div>
                                <label for="{{ form.observaciones.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Observaciones
                                </label>
                                {{ form.observaciones }}
                                {% if form.observaciones.help_text %}
                                    <div class="text-gray-600 text-sm mt-1">{{ form.observaciones.help_text }}</div>
                                {% endif %}
                                {% if form.observaciones.errors %}
                                    <div class="text-red-600 text-sm mt-1">
                                        {% for error in form.observaciones.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Condiciones Especiales -->
                            <div>
                                <label for="{{ form.condiciones_especiales.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Condiciones Especiales
                                </label>
                                {{ form.condiciones_especiales }}
                                {% if form.condiciones_especiales.help_text %}
                                    <div class="text-gray-600 text-sm mt-1">{{ form.condiciones_especiales.help_text }}</div>
                                {% endif %}
                                {% if form.condiciones_especiales.errors %}
                                    <div class="text-red-600 text-sm mt-1">
                                        {% for error in form.condiciones_especiales.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                    </div>
                </div>
                
                <!-- Items de la Orden -->
                <div class="bg-white shadow-sm rounded-lg border border-gray-200 mb-6">
                    <div class="border-b border-gray-200 px-6 py-4">
                        <h5 class="text-lg font-semibold text-gray-900 mb-0">
                            <i class="fas fa-boxes mr-2 text-blue-600"></i>
                            Items de la Orden
                        </h5>
                    </div>
                    <div class="p-6">
                        {% if formset.errors %}
                        <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-md mb-4">
                            <h6 class="font-medium">Errores en los items:</h6>
                            <ul class="list-disc list-inside mt-2">
                                {% for error in formset.non_form_errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}

                        <div id="formset-container">
                            {{ formset.management_form }}
                            
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200" id="items-table">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th style="width: 35%;">Producto *</th>
                                            <th style="width: 20%;">Variante</th>
                                            <th style="width: 12%;">Cantidad *</th>
                                            <th style="width: 15%;">Precio Unit. *</th>
                                            <th style="width: 10%;">Descuento %</th>
                                            <th style="width: 5%;">Eliminar</th>
                                        </tr>
                                    </thead>
                                    <tbody id="formset-body">
                                        {% for form in formset %}
                                        <tr class="formset-row" data-form-prefix="{{ form.prefix }}">
                                            <td>
                                                {{ form.producto }}
                                                {% if form.producto.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {% for error in form.producto.errors %}{{ error }}{% endfor %}
                                                    </div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {{ form.variante }}
                                                {% if form.variante.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {% for error in form.variante.errors %}{{ error }}{% endfor %}
                                                    </div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {{ form.cantidad }}
                                                {% if form.cantidad.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {% for error in form.cantidad.errors %}{{ error }}{% endfor %}
                                                    </div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {{ form.precio_unitario }}
                                                {% if form.precio_unitario.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {% for error in form.precio_unitario.errors %}{{ error }}{% endfor %}
                                                    </div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {{ form.descuento_porcentaje }}
                                                {% if form.descuento_porcentaje.errors %}
                                                    <div class="text-red-600 text-sm">
                                                        {% for error in form.descuento_porcentaje.errors %}{{ error }}{% endfor %}
                                                    </div>
                                                {% endif %}
                                            </td>
                                            <td class="text-center">
                                                {% if form.instance.pk %}
                                                    {{ form.DELETE }}
                                                    <label for="{{ form.DELETE.id_for_label }}" class="inline-flex items-center px-2 py-1 border border-red-300 text-red-700 bg-white hover:bg-red-50 rounded text-sm cursor-pointer">
                                                        <i class="fas fa-trash"></i>
                                                    </label>
                                                {% else %}
                                                    <button type="button" class="inline-flex items-center px-2 py-1 border border-red-300 text-red-700 bg-white hover:bg-red-50 rounded text-sm remove-row">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                {% endif %}
                                                {{ form.id }}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="text-center mt-4">
                            <button type="button" class="border border-blue-600 text-blue-600 bg-white hover:bg-blue-50 px-4 py-2 rounded-md text-sm font-medium transition-colors" id="add-item">
                                <i class="fas fa-plus mr-1"></i> Agregar Item
                            </button>
                        </div>

                        <!-- Template para nuevas filas (oculto) -->
                        <table style="display: none;">
                            <tbody id="empty-form-template">
                                <tr class="formset-row" data-form-prefix="__prefix__">
                                    <td>
                                        {{ formset.empty_form.producto }}
                                    </td>
                                    <td>
                                        {{ formset.empty_form.variante }}
                                    </td>
                                    <td>
                                        {{ formset.empty_form.cantidad }}
                                    </td>
                                    <td>
                                        {{ formset.empty_form.precio_unitario }}
                                    </td>
                                    <td>
                                        {{ formset.empty_form.descuento_porcentaje }}
                                    </td>
                                    <td class="text-center">
                                        <button type="button" class="inline-flex items-center px-2 py-1 border border-red-300 text-red-700 bg-white hover:bg-red-50 rounded text-sm remove-row">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                        {{ formset.empty_form.id }}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Botones de Acción -->
                <div class="bg-white shadow-sm rounded-lg border border-gray-200">
                    <div class="p-6">
                        <div class="flex justify-between">
                            <a href="{% url 'compras:orden_list' %}" class="border border-gray-300 text-gray-700 bg-white hover:bg-gray-50 px-4 py-2 rounded-md text-sm font-medium transition-colors">
                                <i class="fas fa-times mr-1"></i> Cancelar
                            </a>
                            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-md text-sm font-medium transition-colors">
                                <i class="fas fa-save mr-1"></i>
                                {% if object %}
                                    Actualizar Orden
                                {% else %}
                                    Crear Orden
                                {% endif %}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Panel Lateral de Ayuda -->
            <div class="lg:col-span-1">
                <div class="bg-white shadow-sm rounded-lg border border-gray-200">
                    <div class="border-b border-gray-200 px-6 py-4">
                        <h6 class="text-lg font-medium text-gray-900 mb-0">
                            <i class="fas fa-info-circle mr-2 text-blue-600"></i>
                            Información
                        </h6>
                    </div>
                    <div class="p-6">
                        {% if not object %}
                        <div class="bg-blue-50 border border-blue-200 text-blue-700 px-4 py-3 rounded-md mb-4">
                            <h6 class="font-medium mb-2">
                                <i class="fas fa-lightbulb mr-1"></i> Nueva Orden
                            </h6>
                            <p class="text-sm mb-0">
                                El número de orden se generará automáticamente al guardar.
                            </p>
                        </div>
                        {% else %}
                        <div class="bg-yellow-50 border border-yellow-200 text-yellow-700 px-4 py-3 rounded-md mb-4">
                            <h6 class="font-medium mb-2">
                                <i class="fas fa-edit mr-1"></i> Editando Orden
                            </h6>
                            <div class="text-sm">
                                <p><strong>Número:</strong> {{ object.numero }}</p>
                                <p><strong>Estado:</strong> {{ object.get_estado_display }}</p>
                                <p class="mb-0"><strong>Creada:</strong> {{ object.fecha_orden|date:"d/m/Y" }}</p>
                            </div>
                        </div>
                        {% endif %}
                        
                        <h6 class="font-medium text-gray-900 mb-2">Campos Obligatorios:</h6>
                        <ul class="space-y-1 mb-4">
                            <li class="flex items-center text-sm"><i class="fas fa-check-circle text-green-500 mr-2"></i> Proveedor</li>
                        </ul>
                        
                        <h6 class="font-medium text-gray-900 mb-2">Campos Opcionales:</h6>
                        <ul class="space-y-1 mb-4">
                            <li class="flex items-center text-sm"><i class="fas fa-circle text-gray-400 mr-2"></i> Fecha de entrega estimada</li>
                            <li class="flex items-center text-sm"><i class="fas fa-circle text-gray-400 mr-2"></i> Referencia del proveedor</li>
                            <li class="flex items-center text-sm"><i class="fas fa-circle text-gray-400 mr-2"></i> Observaciones</li>
                            <li class="flex items-center text-sm"><i class="fas fa-circle text-gray-400 mr-2"></i> Condiciones especiales</li>
                        </ul>
                        
                        {% if not object %}
                        <div class="bg-gray-50 border border-gray-200 text-gray-700 px-4 py-3 rounded-md">
                            <h6 class="font-medium mb-2">Próximos Pasos:</h6>
                            <ol class="text-sm space-y-1">
                                <li>1. Crear la orden de compra</li>
                                <li>2. Añadir productos a la orden</li>
                                <li>3. Enviar al proveedor</li>
                                <li>4. Gestionar recepción</li>
                            </ol>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Panel de Estado (solo en edición) -->
                {% if object %}
                <div class="bg-white shadow-sm rounded-lg border border-gray-200 mt-6">
                    <div class="border-b border-gray-200 px-6 py-4">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-chart-line me-2 text-success"></i>
                            Estado de la Orden
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <strong>Estado Actual:</strong><br>
                            <span class="badge bg-{% if object.estado == 'borrador' %}secondary{% elif object.estado == 'enviada' %}warning{% elif object.estado == 'confirmada' %}info{% elif object.estado == 'recibida_total' %}success{% elif object.estado == 'cancelada' %}danger{% else %}primary{% endif %}">
                                {{ object.get_estado_display }}
                            </span>
                        </div>
                        
                        <div class="mb-3">
                            <strong>Totales:</strong><br>
                            Subtotal: ${{ object.subtotal|floatformat:0 }}<br>
                            IVA: ${{ object.iva|floatformat:0 }}<br>
                            <strong>Total: ${{ object.total|floatformat:0 }}</strong>
                        </div>
                        
                        <div class="mb-0">
                            <strong>Fechas:</strong><br>
                            Creación: {{ object.fecha_orden|date:"d/m/Y" }}<br>
                            {% if object.fecha_entrega_estimada %}
                            Entrega estimada: {{ object.fecha_entrega_estimada|date:"d/m/Y" }}<br>
                            {% endif %}
                            {% if object.fecha_entrega_real %}
                            Entrega real: {{ object.fecha_entrega_real|date:"d/m/Y" }}
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </form>
</div>

<!-- jQuery y Select2 JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Inicializando formulario de orden de compra...');
    
    // Variables principales
    const addButton = document.getElementById('add-item');
    const formsetBody = document.getElementById('formset-body');
    const totalForms = document.querySelector('#id_items-TOTAL_FORMS');
    const form = document.querySelector('form');
    let formChanged = false;
    
    // Verificar que los elementos existen
    if (!addButton || !formsetBody || !totalForms) {
        console.error('❌ Elementos del formset no encontrados');
        return;
    }
    
    console.log('✅ Elementos del formset encontrados');
    
    // Inicializar Select2 para productos
    function initializeSelect2() {
        $('.select2-producto').select2({
            theme: 'bootstrap-5',
            placeholder: 'Buscar producto...',
            allowClear: true,
            width: '100%',
            language: {
                noResults: function() {
                    return "No se encontraron productos";
                },
                inputTooShort: function() {
                    return "Escribe al menos 2 caracteres";
                }
            },
            minimumInputLength: 2
        });
        
        $('.select2-variante').select2({
            theme: 'bootstrap-5',
            placeholder: 'Seleccionar variante...',
            allowClear: true,
            width: '100%'
        });
    }
    
    // Aplicar estilos Bootstrap y Select2
    function applyStyles() {
        // Aplicar clases Bootstrap
        document.querySelectorAll('#formset-container input[type="number"], #formset-container input[type="text"]').forEach(field => {
            field.classList.add('form-control', 'form-control-sm');
        });
        
        document.querySelectorAll('#formset-container select').forEach(field => {
            if (!field.classList.contains('select2-hidden-accessible')) {
                field.classList.add('form-select', 'form-select-sm');
                
                // Agregar clases para Select2
                if (field.name && field.name.includes('producto')) {
                    field.classList.add('select2-producto');
                } else if (field.name && field.name.includes('variante')) {
                    field.classList.add('select2-variante');
                }
            }
        });
        
        // Inicializar Select2
        initializeSelect2();
    }
    
    // Función para actualizar índices del formset
    function updateFormIndexes() {
        const rows = formsetBody.querySelectorAll('.formset-row');
        rows.forEach((row, index) => {
            const inputs = row.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                const name = input.getAttribute('name');
                if (name && name.includes('items-')) {
                    const newName = name.replace(/items-\d+/, `items-${index}`);
                    input.setAttribute('name', newName);
                    input.setAttribute('id', `id_${newName}`);
                }
            });
            
            row.setAttribute('data-form-prefix', `items-${index}`);
        });
        
        totalForms.value = rows.length;
        console.log(`📊 Formularios actualizados: ${rows.length}`);
    }
    
    // Agregar nuevo item
    addButton.addEventListener('click', function() {
        console.log('➕ Agregando nuevo item...');
        
        const template = document.getElementById('empty-form-template');
        if (!template) {
            console.error('❌ Template no encontrado');
            return;
        }
        
        const formIndex = parseInt(totalForms.value);
        console.log(`📝 Índice del nuevo formulario: ${formIndex}`);
        
        // Crear nueva fila
        const newRow = document.createElement('tr');
        newRow.className = 'formset-row';
        newRow.setAttribute('data-form-prefix', `items-${formIndex}`);
        
        // Obtener el HTML del template y reemplazar __prefix__
        let templateHTML = template.innerHTML;
        templateHTML = templateHTML.replace(/__prefix__/g, formIndex);
        newRow.innerHTML = templateHTML;
        
        // Agregar al DOM
        formsetBody.appendChild(newRow);
        
        // Actualizar contador
        totalForms.value = formIndex + 1;
        
        // Aplicar estilos y funcionalidad
        applyStyles();
        
        // Agregar event listener para eliminar
        const removeBtn = newRow.querySelector('.remove-row');
        if (removeBtn) {
            removeBtn.addEventListener('click', function() {
                console.log('🗑️ Eliminando item...');
                newRow.remove();
                updateFormIndexes();
                applyStyles();
            });
        }
        
        // Focus en el primer campo
        setTimeout(() => {
            const productSelect = newRow.querySelector('select[name*="producto"]');
            if (productSelect) {
                $(productSelect).select2('open');
            }
        }, 100);
        
        console.log('✅ Item agregado exitosamente');
    });
    
    // Event listeners para botones de eliminar existentes
    document.querySelectorAll('.remove-row').forEach(btn => {
        btn.addEventListener('click', function() {
            console.log('🗑️ Eliminando item existente...');
            btn.closest('tr').remove();
            updateFormIndexes();
            applyStyles();
        });
    });
    
    // Detección de cambios
    form.addEventListener('input', () => formChanged = true);
    form.addEventListener('change', () => formChanged = true);
    
    // Confirmación antes de cancelar
    const cancelBtn = form.querySelector('a[href*="orden_list"]');
    if (cancelBtn) {
        cancelBtn.addEventListener('click', function(e) {
            if (formChanged && !confirm('¿Estás seguro de que quieres cancelar? Los cambios se perderán.')) {
                e.preventDefault();
            }
        });
    }
    
    // Aplicar estilos iniciales
    applyStyles();
    
    // Auto-focus en el primer campo
    setTimeout(() => {
        const firstField = document.querySelector('select[name="proveedor"]');
        if (firstField) {
            firstField.focus();
        }
    }, 500);
    
    console.log('🎯 Formulario inicializado completamente');
});
</script>
{% endblock %}