<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba Autocompletado</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .cliente-search-container {
            position: relative;
        }
        
        #cliente-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 1050;
            background: white;
            border: 1px solid #ced4da;
            border-top: none;
            border-radius: 0 0 0.375rem 0.375rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            max-height: 250px;
            overflow-y: auto;
            display: none;
        }
        
        #cliente-suggestions.show {
            display: block !important;
        }
        
        .cliente-option {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            transition: background-color 0.15s ease-in-out;
        }
        
        .cliente-option:hover {
            background-color: #e9ecef;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h2>Prueba de Autocompletado de Clientes</h2>
        
        <div class="row">
            <div class="col-md-6">
                <label class="form-label">Cliente</label>
                <div class="cliente-search-container">
                    <input type="text" 
                           id="id_cliente_search" 
                           class="form-control" 
                           placeholder="Buscar cliente por nombre o documento...">
                    <div id="cliente-suggestions">
                        <!-- Las sugerencias aparecer√°n aqu√≠ -->
                    </div>
                </div>
                <input type="hidden" id="id_cliente" name="cliente">
                
                <!-- Cliente seleccionado -->
                <div id="cliente-seleccionado" class="mt-2 p-3 bg-light rounded" style="display: none;">
                    <div class="d-flex justify-content-between">
                        <div>
                            <strong id="cliente-nombre"></strong><br>
                            <small id="cliente-documento"></small>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearClienteSelection()">
                            √ó
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-4">
            <h4>Debug Info:</h4>
            <div id="debug-info" class="alert alert-info">
                Escriba al menos 2 caracteres para ver sugerencias...
            </div>
        </div>
    </div>

    <script>
        console.log('üöÄ P√°gina de prueba cargada');
        
        // Variables globales para debug
        let debugInfo = document.getElementById('debug-info');
        
        function updateDebug(message) {
            debugInfo.innerHTML += '<br>' + message;
            console.log(message);
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            updateDebug('‚úÖ DOM cargado');
            inicializarAutocompletado();
        });
        
        function inicializarAutocompletado() {
            updateDebug('üîç Inicializando autocompletado...');
            
            const clienteSearch = document.getElementById('id_cliente_search');
            const clienteSuggestions = document.getElementById('cliente-suggestions');
            const clienteHidden = document.getElementById('id_cliente');
            
            if (!clienteSearch || !clienteSuggestions || !clienteHidden) {
                updateDebug('‚ùå Error: No se encontraron elementos DOM');
                return;
            }
            
            updateDebug('‚úÖ Elementos DOM encontrados');
            
            let searchTimeout;
            
            clienteSearch.addEventListener('input', function() {
                const query = this.value.trim();
                updateDebug(`üîç Escribiendo: "${query}"`);
                
                clearTimeout(searchTimeout);
                
                if (query.length < 2) {
                    ocultarSugerencias();
                    return;
                }
                
                searchTimeout = setTimeout(() => {
                    buscarClientes(query);
                }, 300);
            });
            
            document.addEventListener('click', function(event) {
                if (!clienteSearch.contains(event.target) && !clienteSuggestions.contains(event.target)) {
                    ocultarSugerencias();
                }
            });
        }
        
        function buscarClientes(query) {
            updateDebug(`üì° Buscando clientes: "${query}"`);
            
            const url = `/ventas/api/clientes/?q=${encodeURIComponent(query)}`;
            updateDebug(`üåê URL: ${url}`);
            
            fetch(url)
                .then(response => {
                    updateDebug(`üìä Respuesta HTTP: ${response.status}`);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    updateDebug(`üìã Datos recibidos: ${JSON.stringify(data)}`);
                    mostrarSugerencias(data.clientes || []);
                })
                .catch(error => {
                    updateDebug(`‚ùå Error: ${error.message}`);
                });
        }
        
        function mostrarSugerencias(clientes) {
            const clienteSuggestions = document.getElementById('cliente-suggestions');
            
            updateDebug(`üìã Mostrando ${clientes.length} sugerencias`);
            
            if (clientes.length === 0) {
                clienteSuggestions.innerHTML = '<div class="p-2 text-muted">No se encontraron clientes</div>';
                clienteSuggestions.classList.add('show');
                return;
            }
            
            const html = clientes.map(cliente => `
                <div class="cliente-option" onclick="seleccionarCliente(${cliente.id}, '${cliente.nombre_completo.replace(/'/g, "\\'")}', '${cliente.numero_documento}', '${cliente.tipo_documento}')">
                    <div><strong>${cliente.nombre_completo}</strong></div>
                    <small class="text-muted">${cliente.tipo_documento}: ${cliente.numero_documento}</small>
                </div>
            `).join('');
            
            clienteSuggestions.innerHTML = html;
            clienteSuggestions.classList.add('show');
            updateDebug('‚úÖ Sugerencias mostradas');
        }
        
        function seleccionarCliente(id, nombre, documento, tipoDocumento) {
            updateDebug(`‚úÖ Cliente seleccionado: ${nombre}`);
            
            const clienteSearch = document.getElementById('id_cliente_search');
            const clienteHidden = document.getElementById('id_cliente');
            const clienteSeleccionado = document.getElementById('cliente-seleccionado');
            const clienteNombre = document.getElementById('cliente-nombre');
            const clienteDocumento = document.getElementById('cliente-documento');
            
            clienteHidden.value = id;
            clienteSearch.value = `${nombre} - ${documento}`;
            
            clienteNombre.textContent = nombre;
            clienteDocumento.textContent = `${tipoDocumento}: ${documento}`;
            clienteSeleccionado.style.display = 'block';
            
            ocultarSugerencias();
        }
        
        function ocultarSugerencias() {
            const clienteSuggestions = document.getElementById('cliente-suggestions');
            if (clienteSuggestions) {
                clienteSuggestions.classList.remove('show');
                updateDebug('üôà Sugerencias ocultadas');
            }
        }
        
        function clearClienteSelection() {
            updateDebug('üîÑ Limpiando selecci√≥n');
            
            const clienteSearch = document.getElementById('id_cliente_search');
            const clienteHidden = document.getElementById('id_cliente');
            const clienteSeleccionado = document.getElementById('cliente-seleccionado');
            
            clienteHidden.value = '';
            clienteSearch.value = '';
            clienteSeleccionado.style.display = 'none';
            
            ocultarSugerencias();
            clienteSearch.focus();
        }
    </script>
</body>
</html>