{% extends 'base.html' %}
{% load static %}

{% block title %}Optimizar Ruta de Entregas{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
<style>
    .route-optimizer {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px 0;
    }
    
    .optimizer-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .optimizer-header {
        background: linear-gradient(45deg, #1e3c72, #2a5298);
        color: white;
        padding: 20px;
        text-align: center;
    }
    
    .map-container {
        height: 500px;
        position: relative;
        border-radius: 10px;
        overflow: hidden;
        margin: 20px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    #route-map {
        height: 100%;
        width: 100%;
    }
    
    .controls-panel {
        padding: 20px;
        background: #f8f9fa;
        border-top: 1px solid #dee2e6;
    }
    
    .delivery-list {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        background: white;
    }
    
    .delivery-item {
        padding: 15px;
        border-bottom: 1px solid #eee;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .delivery-item:hover {
        background: #f0f8ff;
        transform: translateX(5px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .delivery-item:active {
        background: #e3f2fd;
    }
    
    .delivery-actions {
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .delivery-item:hover .delivery-actions {
        opacity: 1;
    }
    
    .delivery-item:last-child {
        border-bottom: none;
    }
    
    .delivery-order {
        background: #007bff;
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 15px;
        flex-shrink: 0;
    }
    
    .route-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        text-align: center;
        border-left: 4px solid #007bff;
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: #007bff;
        margin-bottom: 5px;
    }
    
    .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .optimize-btn {
        background: linear-gradient(45deg, #28a745, #20c997);
        border: none;
        padding: 15px 30px;
        font-size: 1.1rem;
        font-weight: bold;
        border-radius: 50px;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
    }
    
    .optimize-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
    }
    
    .optimize-btn:disabled {
        background: #6c757d;
        transform: none;
        box-shadow: none;
    }
    
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255,255,255,0.9);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }
    
    .loading-content {
        text-align: center;
        padding: 20px;
    }
    
    .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .alert-custom {
        border-radius: 10px;
        border: none;
        padding: 15px 20px;
        margin-bottom: 20px;
    }
    
    .delivery-details {
        flex: 1;
    }
    
    .delivery-client {
        font-weight: bold;
        color: #333;
        margin-bottom: 5px;
    }
    
    .delivery-address {
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 3px;
    }
    
    .delivery-phone {
        color: #28a745;
        font-size: 0.9rem;
    }
    
    .no-coordinates {
        opacity: 0.6;
        background: #fff3cd;
    }
    
    .route-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
    }
    
    .btn-secondary {
        background: #6c757d;
        border: none;
        padding: 10px 20px;
        border-radius: 25px;
        transition: all 0.3s ease;
    }
    
    .btn-secondary:hover {
        background: #5a6268;
        transform: translateY(-1px);
    }
</style>
{% endblock %}

{% block content %}
<div class="route-optimizer">
    <div class="container">
        <div class="optimizer-card">
            <!-- Header -->
            <div class="optimizer-header">
                <h1><i class="fas fa-route mr-3"></i>Optimizador de Rutas de Entrega</h1>
                <p class="mb-0">Calcula la ruta m√°s eficiente para todas tus entregas</p>
            </div>
            
            <!-- Estad√≠sticas de la Ruta -->
            <div class="controls-panel">
                <div class="route-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="total-entregas">{{ entregas.count }}</div>
                        <div class="stat-label">Entregas Totales</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="entregas-con-gps">-</div>
                        <div class="stat-label">Con Coordenadas GPS</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="distancia-total">-</div>
                        <div class="stat-label">Distancia Total</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="tiempo-total">-</div>
                        <div class="stat-label">Tiempo Estimado</div>
                    </div>
                </div>
                
                <!-- Botones de Acci√≥n -->
                <div class="route-actions">
                    <button class="btn optimize-btn" id="btn-optimizar" onclick="optimizarRuta()">
                        <i class="fas fa-route mr-2"></i>Optimizar Ruta Completa
                    </button>
                    <button class="btn btn-secondary" onclick="limpiarRuta()">
                        <i class="fas fa-eraser mr-2"></i>Limpiar
                    </button>
                    <button class="btn btn-secondary" onclick="centrarMapa()">
                        <i class="fas fa-crosshairs mr-2"></i>Ver Todo
                    </button>
                    <button class="btn btn-secondary" onclick="centrarEnBodega()">
                        <i class="fas fa-warehouse mr-2"></i>Ver Bodega
                    </button>
                    <button class="btn btn-secondary" onclick="exportarRuta()">
                        <i class="fas fa-download mr-2"></i>Exportar
                    </button>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <!-- Mapa -->
            <div class="col-lg-8">
                <div class="optimizer-card">
                    <div class="map-container">
                        <div id="route-map"></div>
                        <div class="loading-overlay" id="loading-overlay">
                            <div class="loading-content">
                                <div class="spinner"></div>
                                <h5>Calculando ruta √≥ptima...</h5>
                                <p class="text-muted">Esto puede tomar unos segundos</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Lista de Entregas -->
            <div class="col-lg-4">
                <div class="optimizer-card">
                    <div class="optimizer-header">
                        <h5><i class="fas fa-list mr-2"></i>Orden de Entregas</h5>
                    </div>
                    
                    <div class="delivery-list" id="delivery-list">
                        {% if entregas %}
                            {% for entrega in entregas %}
                            <div class="delivery-item" 
                                 data-entrega-id="{{ entrega.id }}"
                                 data-enlace-maps="{{ entrega.pedido.cliente.enlace_maps|default:'' }}"
                                 style="cursor: pointer;">
                                <div class="d-flex align-items-center">
                                    <div class="delivery-order">{{ forloop.counter }}</div>
                                    <div class="delivery-details">
                                        <div class="delivery-client">{{ entrega.pedido.cliente.nombre_completo }}</div>
                                        <div class="delivery-address">
                                            <i class="fas fa-map-marker-alt mr-1"></i>{{ entrega.direccion_entrega }}
                                        </div>
                                        <div class="delivery-phone">
                                            <i class="fas fa-phone mr-1"></i>{{ entrega.telefono_contacto }}
                                        </div>
                                        <div class="delivery-actions mt-2">
                                            <button class="btn btn-sm btn-outline-success" 
                                                    onclick="event.stopPropagation(); abrirEnMapsConUrl('{{ entrega.pedido.cliente.enlace_maps }}', '{{ entrega.pedido.cliente.nombre_completo|escapejs }}')">
                                                <i class="fas fa-external-link-alt"></i> Abrir Maps
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="delivery-item text-center text-muted">
                                <i class="fas fa-inbox fa-3x mb-3"></i>
                                <h5>No hay entregas pendientes</h5>
                                <p>No se encontraron entregas para optimizar.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Alertas -->
        <div id="alerts-container" class="mt-3"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<script>
// Variables globales
let map;
let routingControl;
let markers = [];
let entregas = [];
let bodegaCoords = [4.6482, -74.0836]; // Coordenadas de la bodega principal (Bogot√°, Colombia)

// Inicializar mapa
function initMap() {
    console.log('üó∫Ô∏è Inicializando mapa...');
    
    // Crear mapa centrado en Colombia
    map = L.map('route-map').setView([5.4176, -74.8114], 8);
    
    // Agregar tiles de OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 18
    }).addTo(map);
    
    // Agregar marcador de bodega
    const bodegaMarker = L.marker(bodegaCoords, {
        icon: L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        })
    }).addTo(map);
    
    bodegaMarker.bindPopup(`
        <div style="min-width: 200px;">
            <h6><strong>üè¢ Bodega Principal</strong></h6>
            <p class="mb-1"><i class="fas fa-warehouse"></i> Punto de inicio y retorno</p>
            <p class="mb-1"><i class="fas fa-map-marker-alt"></i> Bogot√°, Colombia</p>
            <small class="text-muted">Coordenadas: ${bodegaCoords[0]}, ${bodegaCoords[1]}</small>
            <br><br>
            <button class="btn btn-sm btn-primary" onclick="abrirEnMaps(${bodegaCoords[0]}, ${bodegaCoords[1]}, 'Bodega Principal')">
                <i class="fas fa-external-link-alt"></i> Abrir en Maps
            </button>
        </div>
    `);
    
    console.log('‚úÖ Mapa inicializado correctamente');
}

// Cargar entregas desde el DOM
function cargarEntregas() {
    console.log('üì¶ Cargando entregas...');
    
    entregas = [];
    const deliveryItems = document.querySelectorAll('.delivery-item[data-entrega-id]');
    
    deliveryItems.forEach((item, index) => {
        const entrega = {
            id: item.dataset.entregaId,
            cliente: item.querySelector('.delivery-client').textContent.trim(),
            direccion: item.querySelector('.delivery-address').textContent.replace('üìç', '').trim(),
            telefono: item.querySelector('.delivery-phone').textContent.replace('üìû', '').trim(),
            latitud: item.dataset.lat ? parseFloat(item.dataset.lat) : null,
            longitud: item.dataset.lng ? parseFloat(item.dataset.lng) : null,
            enlace_maps: item.dataset.enlaceMaps || '',
            orden: index + 1
        };
        entregas.push(entrega);
    });
    
    // Actualizar estad√≠sticas
    const entregasConGPS = entregas.filter(e => e.latitud && e.longitud).length;
    document.getElementById('entregas-con-gps').textContent = entregasConGPS;
    
    console.log(`üìä Entregas cargadas: ${entregas.length}, Con GPS: ${entregasConGPS}`);
    
    // Agregar marcadores iniciales
    agregarMarcadores();
}

// Agregar marcadores al mapa
function agregarMarcadores() {
    console.log('üìç Agregando marcadores...');
    
    // Limpiar marcadores existentes (excepto bodega)
    markers.forEach(marker => map.removeLayer(marker));
    markers = [];
    
    const entregasConGPS = entregas.filter(e => e.latitud && e.longitud);
    
    entregasConGPS.forEach((entrega, index) => {
        const marker = L.marker([entrega.latitud, entrega.longitud])
            .addTo(map)
            .bindPopup(`
                <div style="min-width: 250px;">
                    <h6><strong>${entrega.cliente}</strong></h6>
                    <p class="mb-1"><i class="fas fa-map-marker-alt"></i> ${entrega.direccion}</p>
                    <p class="mb-1"><i class="fas fa-phone"></i> ${entrega.telefono}</p>
                    <p class="mb-2"><small class="text-muted">Orden: ${entrega.orden}</small></p>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-primary" onclick="centrarEnEntrega(${entrega.latitud}, ${entrega.longitud})">
                            <i class="fas fa-crosshairs"></i> Centrar
                        </button>
                        <button class="btn btn-sm btn-success" onclick="abrirEnMapsConUrl('${entrega.enlace_maps}', '${entrega.cliente}')">
                            <i class="fas fa-external-link-alt"></i> Abrir Maps
                        </button>
                    </div>
                </div>
            `);
        
        markers.push(marker);
    });
    
    // Ajustar vista si hay marcadores
    if (markers.length > 0) {
        const allMarkers = [...markers];
        // Agregar bodega a la vista
        const bodegaMarker = L.marker(bodegaCoords);
        allMarkers.push(bodegaMarker);
        
        const group = new L.featureGroup(allMarkers);
        map.fitBounds(group.getBounds().pad(0.1));
        
        // Remover marcador temporal de bodega
        map.removeLayer(bodegaMarker);
    }
    
    console.log(`‚úÖ ${markers.length} marcadores agregados`);
}

// Funci√≥n principal de optimizaci√≥n
function optimizarRuta() {
    console.log('üöÄ Iniciando optimizaci√≥n de ruta...');
    
    const btnOptimizar = document.getElementById('btn-optimizar');
    const loadingOverlay = document.getElementById('loading-overlay');
    
    // Mostrar estado de carga
    btnOptimizar.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Calculando...';
    btnOptimizar.disabled = true;
    loadingOverlay.style.display = 'flex';
    
    // Funci√≥n para restaurar estado
    function restaurarEstado() {
        btnOptimizar.innerHTML = '<i class="fas fa-route mr-2"></i>Optimizar Ruta';
        btnOptimizar.disabled = false;
        loadingOverlay.style.display = 'none';
    }
    
    // Filtrar entregas con coordenadas
    const entregasConGPS = entregas.filter(e => e.latitud && e.longitud);
    
    if (entregasConGPS.length === 0) {
        mostrarAlerta('warning', 'No hay entregas con coordenadas GPS para optimizar.');
        restaurarEstado();
        return;
    }
    
    if (entregasConGPS.length === 1) {
        mostrarAlerta('info', 'Solo hay una entrega. No es necesario optimizar la ruta.');
        restaurarEstado();
        return;
    }
    
    // Limpiar ruta anterior
    if (routingControl) {
        map.removeControl(routingControl);
    }
    
    // Crear waypoints incluyendo bodega al inicio y final
    console.log('üöõ Creando ruta desde bodega...');
    
    const waypoints = [];
    
    // 1. Punto de inicio: Bodega
    waypoints.push(L.latLng(bodegaCoords[0], bodegaCoords[1]));
    console.log(`üìç Inicio: Bodega (${bodegaCoords[0]}, ${bodegaCoords[1]})`);
    
    // 2. Todas las entregas
    entregasConGPS.forEach((entrega, index) => {
        waypoints.push(L.latLng(entrega.latitud, entrega.longitud));
        console.log(`üìç Entrega ${index + 1}: ${entrega.cliente} (${entrega.latitud}, ${entrega.longitud})`);
    });
    
    // 3. Punto de retorno: Bodega
    waypoints.push(L.latLng(bodegaCoords[0], bodegaCoords[1]));
    console.log(`ÔøΩ Retorno: Bodega (${bodegaCoords[0]}, ${bodegaCoords[1]})`);
    
    console.log(`üõ£Ô∏è Total waypoints: ${waypoints.length} (bodega + ${entregasConGPS.length} entregas + retorno)`);
    
    try {
        // Crear control de ruta
        routingControl = L.Routing.control({
            waypoints: waypoints,
            routeWhileDragging: false,
            addWaypoints: false,
            createMarker: function(i, waypoint, n) {
                // No crear marcadores adicionales, usamos los nuestros
                return null;
            },
            lineOptions: {
                styles: [{ 
                    color: '#007bff', 
                    weight: 5, 
                    opacity: 0.8,
                    dashArray: '10, 5'
                }]
            },
            router: L.Routing.osrmv1({
                serviceUrl: 'https://router.project-osrm.org/route/v1'
            }),
            formatter: new L.Routing.Formatter({
                language: 'es'
            })
        });
        
        // Eventos del routing
        routingControl.on('routesfound', function(e) {
            console.log('‚úÖ Ruta calculada exitosamente');
            
            const route = e.routes[0];
            const distanciaKm = (route.summary.totalDistance / 1000).toFixed(1);
            const tiempoMin = Math.round(route.summary.totalTime / 60);
            const tiempoHoras = Math.floor(tiempoMin / 60);
            const tiempoMinRestantes = tiempoMin % 60;
            
            // Actualizar estad√≠sticas
            document.getElementById('distancia-total').textContent = `${distanciaKm} km`;
            
            let tiempoTexto;
            if (tiempoHoras > 0) {
                tiempoTexto = `${tiempoHoras}h ${tiempoMinRestantes}min`;
            } else {
                tiempoTexto = `${tiempoMin} min`;
            }
            document.getElementById('tiempo-total').textContent = tiempoTexto;
            
            console.log(`üìä Ruta completa: ${distanciaKm} km en ${tiempoTexto}`);
            console.log(`üöõ Incluye: Bodega ‚Üí ${entregasConGPS.length} entregas ‚Üí Bodega`);
            
            mostrarAlerta('success', 
                `Ruta optimizada calculada: ${distanciaKm} km en ${tiempoTexto}. ` +
                `Incluye salida desde bodega y retorno.`
            );
            
            restaurarEstado();
        });
        
        routingControl.on('routingerror', function(e) {
            console.error('‚ùå Error calculando ruta:', e);
            mostrarAlerta('danger', 'Error al calcular la ruta. Int√©ntalo de nuevo.');
            restaurarEstado();
        });
        
        // A√±adir al mapa
        routingControl.addTo(map);
        
        // Timeout de seguridad
        setTimeout(() => {
            if (btnOptimizar.disabled) {
                console.log('‚è∞ Timeout alcanzado');
                mostrarAlerta('warning', 'El c√°lculo est√° tomando m√°s tiempo del esperado.');
                restaurarEstado();
            }
        }, 15000);
        
    } catch (error) {
        console.error('‚ùå Error creando routing control:', error);
        mostrarAlerta('danger', 'Error del sistema. Int√©ntalo de nuevo.');
        restaurarEstado();
    }
}

// Limpiar ruta
function limpiarRuta() {
    console.log('üßπ Limpiando ruta...');
    
    if (routingControl) {
        map.removeControl(routingControl);
        routingControl = null;
    }
    
    document.getElementById('distancia-total').textContent = '-';
    document.getElementById('tiempo-total').textContent = '-';
    
    mostrarAlerta('info', 'Ruta limpiada.');
}

// Abrir ubicaci√≥n en Google Maps usando URL directa
function abrirEnMapsConUrl(urlMaps, cliente) {
    console.log(`üó∫Ô∏è Abriendo en Google Maps: ${cliente}`);
    console.log(`üîó URL directa: ${urlMaps}`);
    
    if (urlMaps && urlMaps.trim() !== '') {
        window.open(urlMaps, '_blank');
    } else {
        console.error('‚ùå No hay URL de Google Maps para este cliente');
        alert('No se encontr√≥ la ubicaci√≥n de Google Maps para este cliente');
    }
}

// Funci√≥n legacy para coordenadas (para bodega)
function abrirEnMaps(lat, lng, cliente) {
    console.log(`üó∫Ô∏è Abriendo en Google Maps: ${cliente}`);
    
    // Asegurar formato correcto de coordenadas
    const latFormatted = parseFloat(lat).toFixed(6);
    const lngFormatted = parseFloat(lng).toFixed(6);
    
    console.log(`üìç Coordenadas formateadas: ${latFormatted}, ${lngFormatted}`);
    
    const url = `https://www.google.com/maps?q=${latFormatted},${lngFormatted}&hl=es`;
    console.log(`üîó URL generada: ${url}`);
    
    window.open(url, '_blank');
}

// Centrar mapa en la bodega
function centrarEnBodega() {
    console.log('üè¢ Centrando en bodega...');
    map.setView(bodegaCoords, 15);
    
    // Mostrar popup de bodega si existe
    map.eachLayer(function(layer) {
        if (layer instanceof L.Marker) {
            const markerPos = layer.getLatLng();
            if (Math.abs(markerPos.lat - bodegaCoords[0]) < 0.0001 && 
                Math.abs(markerPos.lng - bodegaCoords[1]) < 0.0001) {
                layer.openPopup();
            }
        }
    });
}

// Centrar mapa
function centrarMapa() {
    console.log('üéØ Centrando mapa...');
    
    if (markers.length > 0) {
        // Incluir bodega en la vista
        const allMarkers = [...markers];
        const bodegaMarker = L.marker(bodegaCoords);
        allMarkers.push(bodegaMarker);
        
        const group = new L.featureGroup(allMarkers);
        map.fitBounds(group.getBounds().pad(0.1));
        
        // Remover marcador temporal
        map.removeLayer(bodegaMarker);
    } else {
        // Vista general de Colombia si no hay entregas
        map.setView([5.4176, -74.8114], 8);
    }
}

// Exportar ruta
function exportarRuta() {
    console.log('üíæ Exportando ruta...');
    
    if (!routingControl) {
        mostrarAlerta('warning', 'Primero optimiza la ruta antes de exportar.');
        return;
    }
    
    const entregasConGPS = entregas.filter(e => e.latitud && e.longitud);
    const distancia = document.getElementById('distancia-total').textContent;
    const tiempo = document.getElementById('tiempo-total').textContent;
    
    const data = {
        fecha: new Date().toISOString().split('T')[0],
        ruta_completa: {
            distancia_total: distancia,
            tiempo_total: tiempo,
            incluye_bodega: true,
            punto_inicio: 'Bodega Principal',
            punto_retorno: 'Bodega Principal'
        },
        bodega: {
            nombre: 'Bodega Principal',
            coordenadas: `${bodegaCoords[0]}, ${bodegaCoords[1]}`,
            direccion: 'Carrera 7 #123-45, Bogot√°, Colombia'
        },
        entregas: entregasConGPS.map((entrega, index) => ({
            orden_visita: index + 1,
            cliente: entrega.cliente,
            direccion: entrega.direccion,
            telefono: entrega.telefono,
            coordenadas: `${entrega.latitud}, ${entrega.longitud}`,
            google_maps_url: `https://www.google.com/maps?q=${entrega.latitud},${entrega.longitud}`
        })),
        resumen: {
            total_paradas: entregasConGPS.length + 2, // entregas + salida y retorno bodega
            entregas_programadas: entregasConGPS.length,
            ruta_optimizada: true
        }
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ruta_completa_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    mostrarAlerta('success', 'Ruta completa exportada exitosamente con informaci√≥n de bodega.');
}

// Mostrar alertas
function mostrarAlerta(tipo, mensaje) {
    const container = document.getElementById('alerts-container');
    const alert = document.createElement('div');
    
    alert.className = `alert alert-${tipo} alert-custom alert-dismissible fade show`;
    alert.innerHTML = `
        ${mensaje}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    container.appendChild(alert);
    
    // Auto-remover despu√©s de 5 segundos
    setTimeout(() => {
        if (alert.parentNode) {
            alert.remove();
        }
    }, 5000);
}

// Inicializar cuando cargue la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Inicializando optimizador de rutas...');
    
    initMap();
    cargarEntregas();
    
    console.log('‚úÖ Optimizador de rutas listo');
});
</script>
{% endblock %}