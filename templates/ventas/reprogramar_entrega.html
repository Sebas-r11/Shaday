{% extends 'base.html' %}
{% load static %}
{% load permissions %}

{% block title %}Reprogramar Entrega - DistribucioneShaddai{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-6">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- Header -->
        <div class="mb-8">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">
                        <i class="fas fa-redo mr-3 text-orange-600"></i>
                        Reprogramar Entrega #{{ entrega.pedido.numero }}
                    </h1>
                    <p class="mt-2 text-gray-600">Programa una nueva fecha y asigna repartidor para la entrega fallida</p>
                </div>
                
                <div class="flex space-x-3">
                    <a href="{% url 'ventas:entrega_detail' entrega.id %}" 
                       class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors flex items-center">
                        <i class="fas fa-arrow-left mr-2"></i>Volver al Detalle
                    </a>
                </div>
            </div>
        </div>

        <!-- Información actual de la entrega -->
        <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fas fa-exclamation-triangle text-red-400 text-xl"></i>
                </div>
                <div class="ml-3">
                    <h3 class="text-lg font-medium text-red-800">Entrega Fallida</h3>
                    <div class="mt-2 text-sm text-red-700">
                        <p><strong>Repartidor anterior:</strong> {{ entrega.repartidor.get_full_name|default:entrega.repartidor.username }}</p>
                        <p><strong>Fecha programada anterior:</strong> {{ entrega.fecha_programada|date:"d/m/Y H:i" }}</p>
                        {% if entrega.motivo_fallo %}
                        <p><strong>Motivo del fallo:</strong> {{ entrega.motivo_fallo }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Formulario de reprogramación -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Nueva Programación</h3>
            </div>
            <form id="formReprogramar" class="p-6">
                {% csrf_token %}
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Nueva fecha programada -->
                    <div>
                        <label for="fecha_programada" class="block text-sm font-medium text-gray-700 mb-2">
                            Nueva Fecha Programada *
                        </label>
                        <input type="datetime-local" 
                               id="fecha_programada" 
                               name="fecha_programada" 
                               required
                               min="{{ now|date:'Y-m-d\\TH:i' }}"
                               class="w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500">
                    </div>
                    
                    <!-- Nuevo repartidor -->
                    <div>
                        <label for="repartidor" class="block text-sm font-medium text-gray-700 mb-2">
                            Nuevo Repartidor *
                        </label>
                        <select id="repartidor" 
                                name="repartidor" 
                                required
                                class="w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500">
                            <option value="">Selecciona un repartidor</option>
                            {% for repartidor in repartidores %}
                                <option value="{{ repartidor.id }}" 
                                        {% if repartidor.id == entrega.repartidor.id %}selected{% endif %}>
                                    {{ repartidor.get_full_name|default:repartidor.username }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Nueva dirección de entrega -->
                    <div class="md:col-span-2">
                        <label for="direccion_entrega" class="block text-sm font-medium text-gray-700 mb-2">
                            Dirección de Entrega
                        </label>
                        <textarea id="direccion_entrega" 
                                  name="direccion_entrega" 
                                  rows="3"
                                  class="w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500"
                                  placeholder="Dirección actualizada si es necesario">{{ entrega.direccion_entrega }}</textarea>
                    </div>
                    
                    <!-- Nuevo teléfono de contacto -->
                    <div>
                        <label for="telefono_contacto" class="block text-sm font-medium text-gray-700 mb-2">
                            Teléfono de Contacto
                        </label>
                        <input type="tel" 
                               id="telefono_contacto" 
                               name="telefono_contacto" 
                               value="{{ entrega.telefono_contacto }}"
                               class="w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500"
                               placeholder="Teléfono de contacto actualizado">
                    </div>
                    
                    <!-- Observaciones de reprogramación -->
                    <div>
                        <label for="observaciones_reprogramacion" class="block text-sm font-medium text-gray-700 mb-2">
                            Observaciones de Reprogramación
                        </label>
                        <textarea id="observaciones_reprogramacion" 
                                  name="observaciones_reprogramacion" 
                                  rows="3"
                                  class="w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500"
                                  placeholder="Observaciones sobre la reprogramación (opcional)"></textarea>
                    </div>
                </div>
                
                <!-- Botones -->
                <div class="mt-8 flex justify-end space-x-3">
                    <a href="{% url 'ventas:entrega_detail' entrega.id %}" 
                       class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-6 py-2 rounded-md text-sm font-medium transition-colors">
                        Cancelar
                    </a>
                    <button type="submit" 
                            class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-2 rounded-md text-sm font-medium transition-colors">
                        <i class="fas fa-redo mr-2"></i>Reprogramar Entrega
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Información del pedido -->
        <div class="mt-6 bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Información del Pedido</h3>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Cliente</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ entrega.pedido.cliente.nombre_completo }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Total del Pedido</dt>
                        <dd class="mt-1 text-sm font-bold text-green-600">${{ entrega.pedido.total|floatformat:0 }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Fecha Original</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ entrega.pedido.fecha_creacion|date:"d/m/Y" }}</dd>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading overlay -->
<div id="loadingOverlay" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg p-6 flex items-center">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-orange-600 mr-4"></div>
        <span class="text-gray-700">Reprogramando entrega...</span>
    </div>
</div>

<script>
document.getElementById('formReprogramar').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Validar formulario
    const fechaProgramada = document.getElementById('fecha_programada').value;
    const repartidor = document.getElementById('repartidor').value;
    
    if (!fechaProgramada) {
        alert('Por favor selecciona una nueva fecha programada');
        return;
    }
    
    if (!repartidor) {
        alert('Por favor selecciona un repartidor');
        return;
    }
    
    // Validar que la fecha sea futura
    const fechaSeleccionada = new Date(fechaProgramada);
    const ahora = new Date();
    if (fechaSeleccionada <= ahora) {
        alert('La fecha programada debe ser en el futuro');
        return;
    }
    
    // Mostrar loading
    document.getElementById('loadingOverlay').classList.remove('hidden');
    
    // Preparar datos
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    formData.append('fecha_programada', fechaProgramada);
    formData.append('repartidor', repartidor);
    formData.append('direccion_entrega', document.getElementById('direccion_entrega').value);
    formData.append('telefono_contacto', document.getElementById('telefono_contacto').value);
    formData.append('observaciones_reprogramacion', document.getElementById('observaciones_reprogramacion').value);
    
    // Enviar solicitud
    fetch('{% url "ventas:reprogramar_entrega" entrega.id %}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('loadingOverlay').classList.add('hidden');
        
        if (data.success) {
            alert('Entrega reprogramada exitosamente: ' + data.message);
            if (data.redirect_url) {
                window.location.href = data.redirect_url;
            } else {
                window.location.href = '{% url "ventas:entrega_detail" entrega.id %}';
            }
        } else {
            alert('Error al reprogramar: ' + data.message);
        }
    })
    .catch(error => {
        document.getElementById('loadingOverlay').classList.add('hidden');
        console.error('Error:', error);
        alert('Error inesperado al reprogramar la entrega');
    });
});

// Establecer fecha mínima como ahora + 1 hora
document.addEventListener('DOMContentLoaded', function() {
    const ahora = new Date();
    ahora.setHours(ahora.getHours() + 1); // Agregar 1 hora
    
    const fechaMin = ahora.toISOString().slice(0, 16);
    document.getElementById('fecha_programada').min = fechaMin;
    
    // Sugerir fecha para mañana a las 8 AM
    const manana = new Date();
    manana.setDate(manana.getDate() + 1);
    manana.setHours(8, 0, 0, 0);
    
    const fechaSugerida = manana.toISOString().slice(0, 16);
    document.getElementById('fecha_programada').value = fechaSugerida;
});
</script>
{% endblock %}