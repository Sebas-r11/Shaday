{% extends 'base.html' %}
{% load static %}

{% block title %}Nueva Cotizaci√≥n - DistribucioneShaddai{% endblock %}

{% block content %}
<div class="bg-white shadow rounded-lg">
    <div class="px-6 py-4 border-b border-gray-200">
        <h2 class="text-xl font-semibold text-gray-900">Crear Nueva Cotizaci√≥n</h2>
    </div>

    <form method="post" class="p-6" id="cotizacion-form">
        {% csrf_token %}
        
        {% if form.non_field_errors %}
            <div class="mb-4 p-4 bg-red-100 border-l-4 border-red-500 text-red-700">
                {{ form.non_field_errors }}
            </div>
        {% endif %}

        <!-- Informaci√≥n General -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- Cliente -->
            <div>
                <label for="cliente-search" class="block text-sm font-medium text-gray-700 mb-2">
                    Cliente *
                </label>
                <div class="relative">
                    <input type="text" id="cliente-search" 
                           placeholder="Buscar cliente por nombre o documento..." 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                           autocomplete="off">
                    <input type="hidden" name="cliente" id="id_cliente" value="{{ form.cliente.value|default:'' }}">
                    <div id="cliente-suggestions" class="absolute z-10 bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden max-h-40 overflow-y-auto w-full"></div>
                </div>
                {% if form.cliente.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.cliente.errors.0 }}</p>
                {% endif %}
            </div>

            <!-- Informaci√≥n autom√°tica -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    N√∫mero de Cotizaci√≥n
                </label>
                <div class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-md text-gray-500">
                    Se generar√° autom√°ticamente
                </div>
                <p class="mt-1 text-sm text-gray-500">Formato: COT2025001, COT2025002, etc.</p>
            </div>
        </div>

        <!-- Items de la Cotizaci√≥n -->
        <div class="mb-8">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">Items de la Cotizaci√≥n</h3>
                <button type="button" id="agregar-item" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm">
                    <i class="fas fa-plus mr-2"></i>Agregar Item
                </button>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full border border-gray-200 rounded-lg" id="items-table">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Producto</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cantidad</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Precio Unit.</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Subtotal</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="items-tbody">
                        <!-- Los items se agregar√°n din√°micamente aqu√≠ -->
                    </tbody>
                </table>
            </div>

            <!-- Totales -->
            <div class="mt-4 flex justify-end">
                <div class="w-64 bg-gray-50 p-4 rounded-lg">
                    <div class="flex justify-between mb-2">
                        <span class="text-sm text-gray-600">Subtotal:</span>
                        <span class="text-sm font-medium" id="subtotal-display">$0</span>
                    </div>
                    <div class="flex justify-between text-lg font-semibold border-t pt-2">
                        <span>Total:</span>
                        <span id="total-display">$0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Botones -->
        <div class="flex justify-end space-x-4 pt-6 border-t border-gray-200">
            <a href="{% url 'ventas:cotizacion_list' %}" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-6 py-2 rounded-md">
                Cancelar
            </a>
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md">
                Crear Cotizaci√≥n
            </button>
        </div>
    </form>
</div>

<!-- Template para nuevo item (oculto) -->
<template id="item-template">
    <tr class="item-row">
        <td class="px-4 py-3 border-b">
            <input type="text" class="producto-input w-full px-3 py-2 border border-gray-300 rounded-md" 
                   placeholder="Buscar producto..." autocomplete="off">
            <input type="hidden" class="producto-id" name="productos[]">
            <div class="producto-suggestions absolute z-10 bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden max-h-40 overflow-y-auto"></div>
        </td>
        <td class="px-4 py-3 border-b">
            <input type="number" class="cantidad-input w-full px-3 py-2 border border-gray-300 rounded-md" 
                   name="cantidades[]" min="1" step="0.01" placeholder="1">
        </td>
        <td class="px-4 py-3 border-b">
            <input type="number" class="precio-input w-full px-3 py-2 border border-gray-300 rounded-md" 
                   name="precios[]" min="0" step="0.01" placeholder="0.00" readonly>
        </td>
        <td class="px-4 py-3 border-b">
            <span class="subtotal-item font-medium">$0</span>
        </td>
        <td class="px-4 py-3 border-b">
            <button type="button" class="eliminar-item text-red-600 hover:text-red-800">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    </tr>
</template>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let itemCounter = 0;
    const itemsTable = document.getElementById('items-tbody');
    const agregarBtn = document.getElementById('agregar-item');
    const itemTemplate = document.getElementById('item-template');
    
    // Configurar b√∫squeda de clientes
    setupClienteSearch();

    // Agregar item
    agregarBtn.addEventListener('click', function() {
        const newRow = itemTemplate.content.cloneNode(true);
        const row = newRow.querySelector('.item-row');
        
        // Configurar eventos para el nuevo item
        setupItemEvents(row);
        
        itemsTable.appendChild(newRow);
        itemCounter++;
        
        // Focus en el input de producto
        row.querySelector('.producto-input').focus();
    });

    function setupItemEvents(row) {
        const productoInput = row.querySelector('.producto-input');
        const cantidadInput = row.querySelector('.cantidad-input');
        const precioInput = row.querySelector('.precio-input');
        const productoIdInput = row.querySelector('.producto-id');
        const eliminarBtn = row.querySelector('.eliminar-item');
        const suggestionsDiv = row.querySelector('.producto-suggestions');

        // B√∫squeda de productos
        let searchTimeout;
        productoInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.trim();
            
            if (query.length >= 2) {
                searchTimeout = setTimeout(() => {
                    buscarProductos(query, suggestionsDiv, productoInput, productoIdInput, precioInput);
                }, 300);
            } else {
                suggestionsDiv.innerHTML = '';
                suggestionsDiv.classList.add('hidden');
            }
        });

        // Calcular subtotal cuando cambie cantidad o precio
        cantidadInput.addEventListener('input', calcularSubtotal);
        precioInput.addEventListener('input', calcularSubtotal);

        // Eliminar item
        eliminarBtn.addEventListener('click', function() {
            row.remove();
            calcularTotales();
        });

        function calcularSubtotal() {
            const cantidad = parseFloat(cantidadInput.value) || 0;
            const precio = parseFloat(precioInput.value) || 0;
            const subtotal = cantidad * precio;
            
            row.querySelector('.subtotal-item').textContent = '$' + subtotal.toLocaleString('es-CO', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
            
            calcularTotales();
        }
    }

    function buscarProductos(query, suggestionsDiv, productoInput, productoIdInput, precioInput) {
        fetch(`{% url 'ventas:api_productos' %}?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                suggestionsDiv.innerHTML = '';
                
                if (data.productos && data.productos.length > 0) {
                    data.productos.forEach(producto => {
                        const div = document.createElement('div');
                        div.className = 'px-3 py-2 hover:bg-gray-100 cursor-pointer border-b';
                        div.innerHTML = `
                            <div class="font-medium">${producto.nombre}</div>
                            <div class="text-sm text-gray-500">${producto.codigo} - Stock: ${producto.stock}</div>
                            <div class="text-sm text-green-600">$${producto.precio.toLocaleString('es-CO')}</div>
                        `;
                        
                        div.addEventListener('click', function() {
                            productoInput.value = `${producto.codigo} - ${producto.nombre}`;
                            productoIdInput.value = producto.id;
                            precioInput.value = producto.precio;
                            suggestionsDiv.innerHTML = '';
                            suggestionsDiv.classList.add('hidden');
                            
                            // Focus en cantidad
                            productoInput.closest('tr').querySelector('.cantidad-input').focus();
                        });
                        
                        suggestionsDiv.appendChild(div);
                    });
                    suggestionsDiv.classList.remove('hidden');
                } else {
                    suggestionsDiv.innerHTML = '<div class="px-3 py-2 text-gray-500">No se encontraron productos</div>';
                    suggestionsDiv.classList.remove('hidden');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    function calcularTotales() {
        let subtotalGeneral = 0;
        
        document.querySelectorAll('.item-row').forEach(row => {
            const cantidad = parseFloat(row.querySelector('.cantidad-input').value) || 0;
            const precio = parseFloat(row.querySelector('.precio-input').value) || 0;
            subtotalGeneral += cantidad * precio;
        });
        
        const total = subtotalGeneral;
        
        document.getElementById('subtotal-display').textContent = '$' + subtotalGeneral.toLocaleString('es-CO', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        });
        
        document.getElementById('total-display').textContent = '$' + total.toLocaleString('es-CO', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        });
    }

    function setupClienteSearch() {
        const clienteInput = document.getElementById('cliente-search');
        const clienteHidden = document.getElementById('id_cliente');
        const suggestionsDiv = document.getElementById('cliente-suggestions');
        
        let searchTimeout;
        
        clienteInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.trim();
            
            if (query.length >= 2) {
                searchTimeout = setTimeout(() => {
                    buscarClientes(query, suggestionsDiv, clienteInput, clienteHidden);
                }, 300);
            } else {
                suggestionsDiv.innerHTML = '';
                suggestionsDiv.classList.add('hidden');
                clienteHidden.value = '';
            }
        });
        
        // Si ya hay un cliente seleccionado, mostrar su nombre
        if (clienteHidden.value) {
            // Aqu√≠ podr√≠as hacer una petici√≥n para obtener el nombre del cliente
            // Por simplicidad, dejamos que el usuario reescriba
        }
    }
    
    function buscarClientes(query, suggestionsDiv, clienteInput, clienteHidden) {
        fetch(`{% url 'ventas:api_clientes' %}?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                suggestionsDiv.innerHTML = '';
                
                if (data.clientes && data.clientes.length > 0) {
                    data.clientes.forEach(cliente => {
                        const div = document.createElement('div');
                        div.className = 'px-3 py-2 hover:bg-gray-100 cursor-pointer border-b';
                        div.innerHTML = `
                            <div class="font-medium">${cliente.nombre_completo}</div>
                            <div class="text-sm text-gray-500">${cliente.tipo_documento}: ${cliente.numero_documento}</div>
                            <div class="text-sm text-blue-600">${cliente.tipo_cliente}</div>
                        `;
                        
                        div.addEventListener('click', function() {
                            clienteInput.value = cliente.nombre_completo;
                            clienteHidden.value = cliente.id;
                            suggestionsDiv.innerHTML = '';
                            suggestionsDiv.classList.add('hidden');
                        });
                        
                        suggestionsDiv.appendChild(div);
                    });
                    suggestionsDiv.classList.remove('hidden');
                } else {
                    suggestionsDiv.innerHTML = '<div class="px-3 py-2 text-gray-500">No se encontraron clientes</div>';
                    suggestionsDiv.classList.remove('hidden');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    // Agregar primer item autom√°ticamente
    agregarBtn.click();

    // Manejar env√≠o del formulario
    const form = document.getElementById('cotizacion-form');
    const submitBtn = form.querySelector('button[type="submit"]');
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        console.log('üöÄ Iniciando env√≠o del formulario...');
        
        // Deshabilitar bot√≥n para evitar doble env√≠o
        submitBtn.disabled = true;
        submitBtn.textContent = 'Creando...';
        
        // Mostrar mensaje de procesamiento
        showMessage('Procesando cotizaci√≥n...', 'info');
        
        try {
            // Validar que hay al menos un item
            const itemRows = itemsTable.querySelectorAll('.item-row');
            const itemsValidos = [];
            
            console.log(`üìä Encontradas ${itemRows.length} filas de items`);
            
            itemRows.forEach((row, index) => {
                const productoIdEl = row.querySelector('.producto-id');
                const cantidadEl = row.querySelector('.cantidad-input');
                const precioEl = row.querySelector('.precio-input');
                const productoInputEl = row.querySelector('.producto-input');
                
                // Verificar que los elementos existen antes de acceder a .value
                const productoId = productoIdEl ? productoIdEl.value : '';
                const cantidad = cantidadEl ? cantidadEl.value : '';
                const precio = precioEl ? precioEl.value : '';
                const productoNombre = productoInputEl ? productoInputEl.value : '';
                
                console.log(`Item ${index + 1}:`, {productoId, cantidad, precio, productoNombre});
                
                if (productoId && cantidad && precio && parseFloat(cantidad) > 0) {
                    itemsValidos.push({
                        producto: productoId,
                        cantidad: cantidad,
                        precio: precio,
                        nombre: productoNombre
                    });
                }
            });
            
            console.log(`‚úÖ Items v√°lidos encontrados: ${itemsValidos.length}`);
            
            if (itemsValidos.length === 0) {
                showMessage('‚ùå Debe agregar al menos un producto a la cotizaci√≥n', 'error');
                resetSubmitButton();
                return;
            }
            
            // Validar cliente - usar el ID correcto del campo cliente
            const clienteInput = document.querySelector('input[name="cliente"]') || document.querySelector('select[name="cliente"]');
            const clienteSearchInput = document.getElementById('cliente-search');
            
            const clienteId = clienteInput ? clienteInput.value : '';
            const clienteNombre = clienteSearchInput ? clienteSearchInput.value : '';
            
            console.log('üë§ Cliente:', {clienteId, clienteNombre});
            
            if (!clienteId) {
                showMessage('‚ùå Debe seleccionar un cliente', 'error');
                resetSubmitButton();
                return;
            }
            
            console.log('‚úÖ Validaciones pasadas. Cliente seleccionado correctamente.');
            
            // Limpiar campos ocultos anteriores si existen
            form.querySelectorAll('input[name="productos[]"], input[name="cantidades[]"], input[name="precios[]"]').forEach(input => {
                input.remove();
            });
            
            // Crear campos ocultos para los items
            console.log('üì¶ Creando campos ocultos...');
            itemsValidos.forEach((item, index) => {
                // Productos
                const productoInput = document.createElement('input');
                productoInput.type = 'hidden';
                productoInput.name = 'productos[]';
                productoInput.value = item.producto;
                form.appendChild(productoInput);
                
                // Cantidades
                const cantidadInput = document.createElement('input');
                cantidadInput.type = 'hidden';
                cantidadInput.name = 'cantidades[]';
                cantidadInput.value = item.cantidad;
                form.appendChild(cantidadInput);
                
                // Precios
                const precioInput = document.createElement('input');
                precioInput.type = 'hidden';
                precioInput.name = 'precios[]';
                precioInput.value = item.precio;
                form.appendChild(precioInput);
                
                console.log(`   ‚úÖ Item ${index + 1}: ${item.nombre} - ${item.cantidad} x $${item.precio}`);
            });
            
            // Mostrar resumen antes del env√≠o
            const resumen = `
 Cliente: ${clienteNombre}
üì¶ Items: ${itemsValidos.length}
üí∞ Total estimado: $${itemsValidos.reduce((sum, item) => sum + (parseFloat(item.cantidad) * parseFloat(item.precio)), 0).toLocaleString('es-CO')}
            `;
            console.log('üìã Resumen de la cotizaci√≥n:', resumen);
            
            showMessage('‚úÖ Datos validados. Enviando cotizaci√≥n...', 'success');
            
            // Enviar formulario despu√©s de un peque√±o delay para mostrar el mensaje
            setTimeout(() => {
                console.log('üì§ Enviando formulario...');
                form.submit();
            }, 500);
            
        } catch (error) {
            console.error('‚ùå Error en validaci√≥n:', error);
            showMessage('‚ùå Error al procesar la cotizaci√≥n: ' + error.message, 'error');
            resetSubmitButton();
        }
    });
    
    function resetSubmitButton() {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Crear Cotizaci√≥n';
    }
    
    function showMessage(text, type = 'info') {
        // Remover mensajes anteriores
        const existingMsg = document.querySelector('.status-message');
        if (existingMsg) existingMsg.remove();
        
        // Crear nuevo mensaje
        const messageDiv = document.createElement('div');
        messageDiv.className = `status-message p-4 rounded-md mb-4 ${type === 'error' ? 'bg-red-100 border-l-4 border-red-500 text-red-700' : 
                                type === 'success' ? 'bg-green-100 border-l-4 border-green-500 text-green-700' : 
                                'bg-blue-100 border-l-4 border-blue-500 text-blue-700'}`;
        messageDiv.textContent = text;
        
        // Insertar al inicio del formulario
        form.insertBefore(messageDiv, form.firstChild);
        
        // Auto-remover mensajes de info despu√©s de 3 segundos
        if (type === 'info' || type === 'success') {
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 3000);
        }
    }

    // Ocultar sugerencias cuando se hace click fuera
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.producto-suggestions') && !e.target.closest('.producto-input')) {
            document.querySelectorAll('.producto-suggestions').forEach(div => {
                div.classList.add('hidden');
            });
        }
        if (!e.target.closest('#cliente-suggestions') && !e.target.closest('#cliente-search')) {
            document.getElementById('cliente-suggestions').classList.add('hidden');
        }
    });
});
</script>

<style>
    input[type="text"], input[type="number"], input[type="date"], select, textarea {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        font-size: 0.875rem;
    }
    
    input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus, select:focus, textarea:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }
    
    .producto-suggestions {
        width: 100%;
    }
    
    textarea {
        min-height: 3rem;
        resize: vertical;
    }
</style>
{% endblock %}