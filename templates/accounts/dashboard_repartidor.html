{% extends 'base.html' %}
{% load static %}

{% block title %}Mi Dashboard - Repartidor{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <!-- Leaflet Map (OpenStreetMap) - Gratuito -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet Routing Machine para rutas -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <style>
        .ruta-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .entrega-card {
            transition: all 0.3s ease;
            border-left: 4px solid #e5e7eb;
        }
        .entrega-card.programada {
            border-left-color: #fbbf24;
        }
        .entrega-card.en_camino {
            border-left-color: #3b82f6;
        }
        .entrega-card.entregado {
            border-left-color: #10b981;
        }
        .entrega-card.fallido {
            border-left-color: #ef4444;
        }
        .entrega-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        #map {
            height: 400px;
            border-radius: 8px;
        }
        .estado-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 500;
        }
        .estado-programada {
            background-color: #fef3c7;
            color: #92400e;
        }
        .estado-en_camino {
            background-color: #dbeafe;
            color: #1e40af;
        }
        .estado-entregado {
            background-color: #d1fae5;
            color: #065f46;
        }
        .estado-fallido {
            background-color: #fee2e2;
            color: #991b1b;
        }
    </style>
{% endblock %}

{% block content %}
<div class="bg-gray-50 min-h-screen py-6">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- Header del Repartidor -->
        <div class="mb-8">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">
                        <i class="fas fa-truck mr-3 text-blue-600"></i>
                        Mi Dashboard de Entregas
                    </h1>
                    <p class="mt-2 text-gray-600">Hola {{ user.get_full_name|default:user.username }}, aquí tienes tus entregas del día</p>
                </div>
                
                <div class="flex space-x-3">
                    <button onclick="actualizarUbicacion()" 
                            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium flex items-center">
                        <i class="fas fa-location-arrow mr-2"></i>Mi Ubicación
                    </button>
                </div>
            </div>
        </div>

        <!-- Resumen de Entregas -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-calendar-day text-2xl text-yellow-600"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Entregas Hoy</dt>
                                <dd class="text-2xl font-bold text-gray-900">{{ entregas_hoy }}</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-clock text-2xl text-orange-600"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Pendientes</dt>
                                <dd class="text-2xl font-bold text-gray-900">{{ entregas_pendientes }}</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-shipping-fast text-2xl text-blue-600"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">En Camino</dt>
                                <dd class="text-2xl font-bold text-gray-900">{{ entregas_en_camino }}</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-check-circle text-2xl text-green-600"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Completadas</dt>
                                <dd class="text-2xl font-bold text-gray-900">{{ total_entregas_realizadas }}</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-times-circle text-2xl text-red-600"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Fallidas</dt>
                                <dd class="text-2xl font-bold text-gray-900">{{ entregas_fallidas }}</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mapa y Ruta Optimizada -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="lg:col-span-2">
                <div class="bg-white shadow rounded-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-900">
                            <i class="fas fa-map-marked-alt mr-2 text-blue-600"></i>
                            Ruta Optimizada del Día
                        </h2>
                        <div class="flex space-x-2">
                            <span class="text-sm text-gray-500">
                                <i class="fas fa-route mr-1"></i>
                                Distancia: <span id="distancia-total">Calculando...</span>
                            </span>
                            <span class="text-sm text-gray-500">
                                <i class="fas fa-clock mr-1"></i>
                                Tiempo: <span id="tiempo-total">Calculando...</span>
                            </span>
                        </div>
                    </div>
                    <div id="map"></div>
                </div>
            </div>

            <div class="lg:col-span-1">
                <div class="ruta-card shadow rounded-lg p-6">
                    <h3 class="text-xl font-semibold mb-4">
                        <i class="fas fa-list-ol mr-2"></i>
                        Orden de Entrega
                    </h3>
                    <div id="orden-entregas" class="space-y-3">
                        {% for entrega in entregas_para_ruta %}
                        <div class="bg-white bg-opacity-20 rounded-lg p-3 text-sm" data-entrega-id="{{ entrega.id }}">
                            <div class="font-medium">{{ forloop.counter }}. {{ entrega.pedido.cliente.nombre_completo }}</div>
                            <div class="text-xs opacity-90 mt-1">{{ entrega.direccion_entrega }}</div>
                            <div class="text-xs opacity-75 mt-1">
                                <i class="fas fa-phone mr-1"></i>{{ entrega.telefono_contacto }}
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center py-4 text-white text-opacity-75">
                            <i class="fas fa-check-circle text-3xl mb-2"></i>
                            <p>¡No hay entregas pendientes!</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Lista de Entregas -->
        <div class="bg-white shadow rounded-lg overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-900">
                    <i class="fas fa-boxes mr-2 text-blue-600"></i>
                    Mis Entregas Recientes
                </h2>
            </div>
            <div class="divide-y divide-gray-200">
                {% for entrega in entregas_recientes %}
                <div class="entrega-card {{ entrega.estado }} p-6 hover:bg-gray-50">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-lg font-medium text-gray-900">
                                    Pedido #{{ entrega.pedido.numero_pedido }}
                                </h3>
                                <span class="estado-badge estado-{{ entrega.estado }}">
                                    {% if entrega.estado == 'programada' %}
                                        <i class="fas fa-clock mr-1"></i>Programada
                                    {% elif entrega.estado == 'en_camino' %}
                                        <i class="fas fa-shipping-fast mr-1"></i>En Camino
                                    {% elif entrega.estado == 'entregado' %}
                                        <i class="fas fa-check-circle mr-1"></i>Entregado
                                    {% elif entrega.estado == 'fallido' %}
                                        <i class="fas fa-times-circle mr-1"></i>Fallido
                                    {% endif %}
                                </span>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-gray-600">
                                <div>
                                    <i class="fas fa-user mr-2 text-gray-400"></i>
                                    <strong>Cliente:</strong> {{ entrega.pedido.cliente.nombre_completo }}
                                </div>
                                <div>
                                    <i class="fas fa-map-marker-alt mr-2 text-gray-400"></i>
                                    <strong>Dirección:</strong> {{ entrega.direccion_entrega }}
                                </div>
                                <div>
                                    <i class="fas fa-calendar mr-2 text-gray-400"></i>
                                    <strong>Fecha:</strong> {{ entrega.fecha_programada }}
                                </div>
                            </div>
                            
                            {% if entrega.telefono_contacto %}
                            <div class="mt-2 text-sm text-gray-600">
                                <i class="fas fa-phone mr-2 text-gray-400"></i>
                                <strong>Teléfono:</strong> {{ entrega.telefono_contacto }}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="ml-6 flex flex-col space-y-2">
                            {% if entrega.estado == 'programada' %}
                                <button onclick="iniciarEntrega({{ entrega.id }})" 
                                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                                    <i class="fas fa-play mr-1"></i>Iniciar
                                </button>
                            {% elif entrega.estado == 'en_camino' %}
                                <button onclick="completarEntrega({{ entrega.id }})" 
                                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                                    <i class="fas fa-check mr-1"></i>Completar
                                </button>
                                <button onclick="marcarFallida({{ entrega.id }})" 
                                        class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                                    <i class="fas fa-times mr-1"></i>Fallida
                                </button>
                            {% endif %}
                            
                            <button onclick="verDetalleEntrega({{ entrega.id }})" 
                                    class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                                <i class="fas fa-eye mr-1"></i>Ver
                            </button>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="p-6 text-center text-gray-500">
                    <i class="fas fa-clipboard-list text-3xl mb-4"></i>
                    <p>No tienes entregas asignadas</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Modal para detalles de entrega -->
<div id="modal-detalle" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">Detalle de Entrega</h3>
                <button onclick="cerrarModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="contenido-modal">
                <!-- Contenido dinámico del modal -->
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let map;
let routingControl;
let userLocation = null;
let markers = [];

// Inicializar mapa con Leaflet
function initMap() {
    // Madrid por defecto
    const defaultCenter = [40.4168, -3.7038];
    
    map = L.map('map').setView(defaultCenter, 13);
    
    // Agregar capa de OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Obtener ubicación actual
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                userLocation = [position.coords.latitude, position.coords.longitude];
                map.setView(userLocation, 14);
                
                // Agregar marcador de ubicación actual
                L.marker(userLocation)
                    .addTo(map)
                    .bindPopup('Mi ubicación actual')
                    .openPopup();
                
                console.log('✅ Ubicación actualizada');
            },
            (error) => {
                console.log("Error obteniendo ubicación:", error);
                // Usar ubicación por defecto
                userLocation = defaultCenter;
                console.log('⚠️ Usando ubicación por defecto');
            }
        );
    } else {
        console.log("Geolocalización no soportada");
        userLocation = defaultCenter;
        console.log('⚠️ Usando ubicación por defecto');
    }
}

function actualizarOrdenEntregas(orden) {
    const container = document.getElementById('orden-entregas');
    if (!container) return;
    
    const items = Array.from(container.children);
    
    // Reordenar según el orden proporcionado
    container.innerHTML = '';
    orden.forEach((index, position) => {
        if (items[index]) {
            const item = items[index].cloneNode(true);
            const numero = item.querySelector('.font-medium');
            if (numero) {
                numero.textContent = numero.textContent.replace(/^\d+\./, `${position + 1}.`);
            }
            container.appendChild(item);
        }
    });
}

// Funciones de estado de entrega
function iniciarEntrega(entregaId) {
    if (confirm('¿Iniciar esta entrega?')) {
        fetch(`/api/entregas/${entregaId}/iniciar/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error al iniciar entrega: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error de conexión');
        });
    }
}

function completarEntrega(entregaId) {
    if (confirm('¿Marcar como entregada?')) {
        fetch(`/api/entregas/${entregaId}/completar/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error al completar entrega: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error de conexión');
        });
    }
}

function marcarFallida(entregaId) {
    const motivo = prompt('Motivo de la falla:');
    if (motivo) {
        fetch(`/api/entregas/${entregaId}/fallar/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ motivo: motivo })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error al marcar como fallida: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error de conexión');
        });
    }
}

function verDetalleEntrega(entregaId) {
    fetch(`/api/entregas/${entregaId}/detalle/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('contenido-modal').innerHTML = data.html;
                document.getElementById('modal-detalle').classList.remove('hidden');
            } else {
                alert('Error al cargar detalle: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error de conexión');
        });
}

function cerrarModal() {
    document.getElementById('modal-detalle').classList.add('hidden');
}

function actualizarUbicacion() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                userLocation = [position.coords.latitude, position.coords.longitude];
                map.setView(userLocation, 14);
                
                // Remover marcador anterior si existe
                if (window.userMarker) {
                    map.removeLayer(window.userMarker);
                }
                
                // Agregar nuevo marcador de ubicación
                window.userMarker = L.marker(userLocation)
                    .addTo(map)
                    .bindPopup('Mi ubicación actualizada')
                    .openPopup();
                
                console.log('✅ Ubicación actualizada manualmente');
                
                // Enviar ubicación al servidor
                fetch('/api/repartidor/ubicacion/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        lat: userLocation[0],
                        lng: userLocation[1]
                    })
                });
            },
            (error) => {
                alert('No se pudo obtener la ubicación: ' + error.message);
            }
        );
    } else {
        alert('Geolocalización no soportada en este navegador');
    }
}

// Función auxiliar para obtener cookie CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Inicializar mapa cuando se carga la página
document.addEventListener('DOMContentLoaded', function() {
    initMap();
});
</script>
{% endblock %}